{% extends "layout.html" %}

{% block title %}–ö–∞—Ä—Ç–∞ –ø–æ–º–µ—â–µ–Ω–∏–π - –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ª—é–¥–µ–π{% endblock %}

{% block body_class %}security-page{% endblock %}

{% block content %}
<div class="security-monitor">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="monitor-nav">
        <a href="/" class="nav-link">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">DASHBOARD</span>
        </a>
        <a href="/video" class="nav-link">
            <span class="nav-icon">üìπ</span>
            <span class="nav-text">VIDEO</span>
        </a>
        <a href="/statistics" class="nav-link">
            <span class="nav-icon">üìà</span>
            <span class="nav-text">STATISTICS</span>
        </a>
        <a href="/map" class="nav-link active">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-text">MAP</span>
        </a>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã -->
    <div class="monitor-header">
        <div class="header-left">
            <div class="monitor-title">FACILITY MAP</div>
            <div class="monitor-subtitle">REAL-TIME TRACKING</div>
        </div>
        <div class="header-right">
            <div class="monitor-time" id="monitor-time"></div>
            <div class="monitor-date" id="monitor-date"></div>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π -->
    <div class="security-section">
        <div class="section-header">
            <span class="section-title">MAP CONTROLS</span>
        </div>
        <div class="map-controls">
            <div class="control-group">
                <label for="room-select-map" class="control-label">ROOM:</label>
                <select id="room-select-map" class="security-select" onchange="switchRoom()">
                    <option value="all">ALL ROOMS</option>
                </select>
            </div>
            <button type="button" class="security-btn" onclick="toggleTrajectories()">TOGGLE TRAJECTORIES</button>
            <button type="button" class="security-btn" onclick="clearTrajectories()">CLEAR TRAJECTORIES</button>
            <button type="button" class="security-btn" onclick="resetZoom()">RESET ZOOM</button>
            <label class="control-label">
                <input type="checkbox" id="show-distances" checked> SHOW DISTANCES
            </label>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div class="security-section">
        <div class="section-header">
            <span class="section-title">FACILITY LAYOUT</span>
            <span class="section-indicator">‚óè</span>
        </div>
        <div class="map-container">
            <canvas id="room-map" class="security-canvas"></canvas>
        </div>
    </div>

    <!-- –õ–µ–≥–µ–Ω–¥–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="security-section">
        <div class="section-header">
            <span class="section-title">LEGEND &amp; INFO</span>
        </div>
        <div class="map-info-grid">
            <div class="legend-container" id="map-legend">
                <div class="text-center security-loading">LOADING...</div>
            </div>
            <div class="selected-person-info" id="selected-person">
                <div class="info-title">SELECTED SUBJECT</div>
                <div class="info-content" id="person-details">CLICK ON A POINT</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let mapConfig = null;
let roomStatus = {};
let peoplePositions = {}; // {room: [{id, x, y, distance_m, timestamp}, ...]}
let personTrajectories = {}; // {person_id: [{x, y, timestamp, room}, ...]}
let showTrajectories = true;
let showDistances = true;
let selectedPerson = null;
let selectedRoom = "all"; // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ("all" = –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã)
let mapScale = 1.0;
let mapOffsetX = 0;
let mapOffsetY = 0;
let isDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ru-RU', {hour12: false});
    const dateStr = now.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    }).replace(/\//g, '.');

    document.getElementById('monitor-time').textContent = timeStr;
    document.getElementById('monitor-date').textContent = dateStr;
}
updateTime();
setInterval(updateTime, 1000);

// WebSocket
const socket = io();
socket.on('connect', function() {
    console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
    loadMapConfig();
    updateRoomStatus();
    updatePositions();
});

socket.on('room_update', function(data) {
    roomStatus = data;
    drawMap();
});

socket.on('positions_update', function(data) {
    peoplePositions = data;
    drawMap();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
function loadMapConfig() {
    fetch('/api/room_map')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(config => {
            if (config.error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:', config.error);
                document.getElementById('map-legend').innerHTML = 
                    '<div class="text-center security-loading" style="color: #ff0000;">ERROR: ' + config.error + '</div>';
                return;
            }
            mapConfig = config;
            const canvas = document.getElementById('room-map');
            if (!canvas) {
                console.error('Canvas —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            canvas.width = config.canvas_width || 800;
            canvas.height = config.canvas_height || 600;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel);
            
            drawMap();
            updateLegend();
            loadTrajectories();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            document.getElementById('map-legend').innerHTML = 
                '<div class="text-center security-loading" style="color: #ff0000;">ERROR LOADING MAP CONFIG</div>';
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–º–Ω–∞—Ç
function updateRoomStatus() {
    fetch('/api/rooms')
        .then(response => response.json())
        .then(data => {
            roomStatus = data;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
            const select = document.getElementById('room-select-map');
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="all">ALL ROOMS</option>';
                
                Object.keys(data).forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = room;
                    select.appendChild(option);
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                select.value = currentValue || 'all';
            }
            
            drawMap();
        });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
function switchRoom() {
    const select = document.getElementById('room-select-map');
    selectedRoom = select ? select.value : 'all';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ–º–Ω–∞—Ç—É
    if (selectedRoom !== 'all' && mapConfig) {
        const room = mapConfig.rooms.find(r => r.name === selectedRoom);
        if (room) {
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –∫–æ–º–Ω–∞—Ç–µ
            const canvas = document.getElementById('room-map');
            mapOffsetX = (canvas.width / 2) - (room.x + room.width / 2);
            mapOffsetY = (canvas.height / 2) - (room.y + room.height / 2);
            mapScale = 1.5; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–∑–æ—Ä–∞
        }
    } else {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç
        resetZoom();
    }
    
    drawMap();
    updateLegend();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π
function updatePositions() {
    fetch('/api/positions')
        .then(response => response.json())
        .then(data => {
            peoplePositions = data;
            drawMap();
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
function loadTrajectories() {
    fetch('/api/trajectories')
        .then(response => response.json())
        .then(data => {
            personTrajectories = data;
            drawMap();
        });
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã
function drawMap() {
    if (!mapConfig) return;
    
    const canvas = document.getElementById('room-map');
    const ctx = canvas.getContext('2d');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    ctx.save();
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–º–∞—Å—à—Ç–∞–± –∏ —Å–º–µ—â–µ–Ω–∏–µ)
    ctx.translate(mapOffsetX, mapOffsetY);
    ctx.scale(mapScale, mapScale);
    
    // –û—á–∏—â–∞–µ–º canvas
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(-mapOffsetX / mapScale, -mapOffsetY / mapScale, canvas.width / mapScale, canvas.height / mapScale);
    
    // –†–∏—Å—É–µ–º –∫–æ–º–Ω–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é, –µ—Å–ª–∏ –Ω–µ "all")
    mapConfig.rooms.forEach(room => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
        if (selectedRoom !== 'all' && room.name !== selectedRoom) {
            return;
        }
        
        const roomData = roomStatus[room.name] || {count: 0, persons: []};
        
        // –†–∏—Å—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∫–æ–º–Ω–∞—Ç—ã
        ctx.fillStyle = room.color || '#00ff00';
        ctx.globalAlpha = 0.2;
        ctx.fillRect(room.x, room.y, room.width, room.height);
        ctx.globalAlpha = 1.0;
        
        // –†–∏—Å—É–µ–º –≥—Ä–∞–Ω–∏—Ü—É (–±–æ–ª–µ–µ —è—Ä–∫—É—é –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã)
        ctx.strokeStyle = (selectedRoom === 'all' || room.name === selectedRoom) ? '#00ff00' : '#00aa00';
        ctx.lineWidth = (selectedRoom === 'all' || room.name === selectedRoom) ? 2 : 1;
        ctx.strokeRect(room.x, room.y, room.width, room.height);
        
        // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        ctx.fillStyle = '#00ff00';
        ctx.font = 'bold 16px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText(room.name, room.x + room.width / 2, room.y + 25);
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π
        ctx.font = 'bold 20px Courier New';
        ctx.fillStyle = '#ffff00';
        ctx.fillText(`${roomData.count}`, room.x + room.width / 2, room.y + 55);
    });
    
    // –†–∏—Å—É–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã)
    if (showTrajectories) {
        Object.keys(personTrajectories).forEach(personId => {
            const trajectory = personTrajectories[personId];
            if (trajectory.length < 2) return;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
            let filteredTrajectory = trajectory;
            if (selectedRoom !== 'all') {
                filteredTrajectory = trajectory.filter(p => p.room === selectedRoom);
                if (filteredTrajectory.length < 2) return;
            }
            
            ctx.strokeStyle = '#00aa00';
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            
            for (let i = 0; i < filteredTrajectory.length; i++) {
                const point = filteredTrajectory[i];
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            }
            ctx.stroke();
            ctx.globalAlpha = 1.0;
        });
    }
    
    // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –ª—é–¥–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã)
    Object.keys(peoplePositions).forEach(roomName => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
        if (selectedRoom !== 'all' && roomName !== selectedRoom) {
            return;
        }
        
        const positions = peoplePositions[roomName];
        positions.forEach(pos => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const timeSinceUpdate = (Date.now() / 1000) - pos.timestamp;
            let pointColor = '#00ff00'; // –ó–µ–ª–µ–Ω—ã–π - —Ç–æ–ª—å–∫–æ –≤–æ—à–µ–ª
            if (timeSinceUpdate > 2) {
                pointColor = '#ffff00'; // –ñ–µ–ª—Ç—ã–π - –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã
            }
            if (timeSinceUpdate > 5) {
                pointColor = '#ff0000'; // –ö—Ä–∞—Å–Ω—ã–π - –ø–æ–∫–∏–¥–∞–µ—Ç –∏–ª–∏ –ø—Ä–æ–ø–∞–ª
            }
            
            // –†–∏—Å—É–µ–º —Ç–æ—á–∫—É
            ctx.fillStyle = pointColor;
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // –û–±–≤–æ–¥–∫–∞ —Ç–æ—á–∫–∏
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ID —á–µ–ª–æ–≤–µ–∫–∞
            ctx.fillStyle = '#00ff00';
            ctx.font = 'bold 12px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(pos.id, pos.x, pos.y - 15);
            
            // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
            if (showDistances && pos.distance_m !== null) {
                ctx.fillStyle = '#00aa00';
                ctx.font = '10px Courier New';
                ctx.fillText(`${pos.distance_m.toFixed(1)}m`, pos.x, pos.y + 25);
            }
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
            if (selectedPerson === pos.id) {
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 15, 0, Math.PI * 2);
                ctx.stroke();
            }
        });
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    ctx.restore();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
function handleCanvasClick(event) {
    const canvas = document.getElementById('room-map');
    const rect = canvas.getBoundingClientRect();
    const x = (event.clientX - rect.left - mapOffsetX) / mapScale;
    const y = (event.clientY - rect.top - mapOffsetY) / mapScale;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ —Ç–æ—á–∫—É —á–µ–ª–æ–≤–µ–∫–∞
    let clickedPerson = null;
    Object.keys(peoplePositions).forEach(roomName => {
        const positions = peoplePositions[roomName];
        positions.forEach(pos => {
            const distance = Math.sqrt((x - pos.x)**2 + (y - pos.y)**2);
            if (distance < 15) {
                clickedPerson = pos;
            }
        });
    });
    
    if (clickedPerson) {
        selectedPerson = clickedPerson.id;
        showPersonInfo(clickedPerson);
        drawMap();
    } else {
        selectedPerson = null;
        document.getElementById('person-details').textContent = 'CLICK ON A POINT';
    }
}

// –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–µ–ª–æ–≤–µ–∫–µ
function showPersonInfo(person) {
    const details = document.getElementById('person-details');
    const trajectory = personTrajectories[person.id] || [];
    const timeInRoom = trajectory.length > 0 ? 
        ((Date.now() / 1000) - trajectory[0].timestamp).toFixed(0) : 0;
    
    details.innerHTML = `
        <div><strong>ID:</strong> ${person.id}</div>
        <div><strong>POSITION:</strong> (${person.x.toFixed(1)}, ${person.y.toFixed(1)})</div>
        ${person.distance_m ? `<div><strong>DISTANCE:</strong> ${person.distance_m.toFixed(2)}m</div>` : ''}
        <div><strong>TIME IN ROOM:</strong> ${timeInRoom}s</div>
        <div><strong>TRAJECTORY POINTS:</strong> ${trajectory.length}</div>
    `;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
function toggleTrajectories() {
    showTrajectories = !showTrajectories;
    drawMap();
}

function clearTrajectories() {
    personTrajectories = {};
    drawMap();
}

function resetZoom() {
    mapScale = 1.0;
    mapOffsetX = 0;
    mapOffsetY = 0;
    drawMap();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º—ã—à–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
function handleMouseDown(event) {
    isDragging = true;
    lastMouseX = event.clientX;
    lastMouseY = event.clientY;
}

function handleMouseMove(event) {
    if (isDragging) {
        mapOffsetX += event.clientX - lastMouseX;
        mapOffsetY += event.clientY - lastMouseY;
        lastMouseX = event.clientX;
        lastMouseY = event.clientY;
        drawMap();
    }
}

function handleMouseUp(event) {
    isDragging = false;
}

function handleWheel(event) {
    event.preventDefault();
    const delta = event.deltaY > 0 ? 0.9 : 1.1;
    mapScale *= delta;
    mapScale = Math.max(0.5, Math.min(3.0, mapScale)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
    drawMap();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
function updateLegend() {
    if (!mapConfig) return;
    
    const legend = document.getElementById('map-legend');
    let html = '';
    
    html += '<div class="legend-item"><div class="legend-color" style="background: #00ff00;"></div><div class="legend-info"><div class="legend-name">NEW ENTRY</div></div></div>';
    html += '<div class="legend-item"><div class="legend-color" style="background: #ffff00;"></div><div class="legend-info"><div class="legend-name">IN ROOM</div></div></div>';
    html += '<div class="legend-item"><div class="legend-color" style="background: #ff0000;"></div><div class="legend-info"><div class="legend-name">LEAVING</div></div></div>';
    
    mapConfig.rooms.forEach(room => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ–º–Ω–∞—Ç—É –≤ –ª–µ–≥–µ–Ω–¥–µ, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è
        if (selectedRoom !== 'all' && room.name !== selectedRoom) {
            return;
        }
        
        const roomData = roomStatus[room.name] || {count: 0, persons: []};
        const isSelected = (selectedRoom === 'all' || room.name === selectedRoom);
        html += `
            <div class="legend-item ${isSelected ? 'legend-selected' : ''}">
                <div class="legend-color" style="background: ${room.color || '#00ff00'};"></div>
                <div class="legend-info">
                    <div class="legend-name">${room.name}${isSelected && selectedRoom !== 'all' ? ' [ACTIVE]' : ''}</div>
                    <div class="legend-details">
                        SUBJECTS: <span class="value">${roomData.count}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    legend.innerHTML = html;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
document.getElementById('show-distances').addEventListener('change', function() {
    showDistances = this.checked;
    drawMap();
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
setInterval(updateRoomStatus, 2000);
setInterval(updatePositions, 500); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫—É–Ω–¥—ã
setInterval(loadTrajectories, 2000);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
updateRoomStatus();
</script>
{% endblock %}