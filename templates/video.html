{% extends "layout.html" %}

{% block title %}–í–∏–¥–µ–æ - –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ª—é–¥–µ–π{% endblock %}

{% block body_class %}video-page{% endblock %}

{% block content %}
<div class="security-monitor">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="monitor-nav">
        <a href="/" class="nav-link">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">DASHBOARD</span>
        </a>
        <a href="/video" class="nav-link active">
            <span class="nav-icon">üìπ</span>
            <span class="nav-text">VIDEO</span>
        </a>
        <a href="/statistics" class="nav-link">
            <span class="nav-icon">üìà</span>
            <span class="nav-text">STATISTICS</span>
        </a>
        <a href="/map" class="nav-link">
            <span class="nav-icon">üó∫Ô∏è</span>
            <span class="nav-text">MAP</span>
        </a>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã -->
    <div class="monitor-header">
        <div class="header-left">
            <div class="monitor-title">SECURITY MONITORING SYSTEM</div>
            <div class="monitor-subtitle">FACILITY SURVEILLANCE</div>
        </div>
        <div class="header-right">
            <div class="monitor-time" id="monitor-time"></div>
            <div class="monitor-date" id="monitor-date"></div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
    <div class="system-status">
        <div class="status-item">
            <span class="status-label">SYSTEM:</span>
            <span class="status-value online">OPERATIONAL</span>
        </div>
        <div class="status-item">
            <span class="status-label">CAMERAS:</span>
            <span class="status-value" id="total-cameras">{{ rooms|length }}</span>
        </div>
        <div class="status-item">
            <span class="status-label">SUBJECTS:</span>
            <span class="status-value" id="total-subjects">0</span>
        </div>
    </div>

    <!-- –°–µ—Ç–∫–∞ –∫–∞–º–µ—Ä -->
    <div class="camera-grid" id="video-container">
        {% for room in rooms %}
        <div class="camera-feed" data-room="{{ room }}">
            <div class="camera-frame">
                <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–∞–º–µ—Ä—ã -->
                <div class="camera-header">
                    <div class="camera-info">
                        <span class="camera-label">{{ room }}</span>
                        <span class="camera-id">CAM-{{ "%02d"|format(loop.index) }}</span>
                    </div>
                    <div class="camera-status" id="status-{{ room }}">
                        <span class="status-dot"></span>
                        <span class="status-text">INIT</span>
                    </div>
                </div>

                <!-- –í–∏–¥–µ–æ –æ–±–ª–∞—Å—Ç—å -->
                <div class="camera-view">
                    <div class="video-container">
                        <img src="{{ url_for('video_feed', room_name=room) }}" 
                             class="camera-image" 
                             id="video-{{ room }}"
                             alt="{{ room }}"
                             onerror="handleVideoError('{{ room }}')">
                    </div>
                    <div class="video-static"></div>

                    <!-- –û–≤–µ—Ä–ª–µ–∏ –Ω–∞ –≤–∏–¥–µ–æ -->
                    <div class="camera-overlay">
                        <!-- –í–µ—Ä—Ö–Ω–∏–π –æ–≤–µ—Ä–ª–µ–π -->
                        <div class="overlay-top">
                            <div class="overlay-item">
                                <span class="overlay-label">TIME:</span>
                                <span class="overlay-value timestamp" id="time-{{ room }}">--:--:--</span>
                            </div>
                            <div class="overlay-item">
                                <span class="overlay-label">FPS:</span>
                                <span class="overlay-value" id="fps-{{ room }}">--</span>
                            </div>
                        </div>

                        <!-- –ù–∏–∂–Ω–∏–π –æ–≤–µ—Ä–ª–µ–π -->
                        <div class="overlay-bottom">
                            <div class="overlay-item">
                                <span class="overlay-label">SUBJECTS:</span>
                                <span class="overlay-value people-count" id="count-{{ room }}">0</span>
                            </div>
                            <div class="overlay-item">
                                <span class="overlay-label">RES:</span>
                                <span class="overlay-value" id="res-{{ room }}">--x--</span>
                            </div>
                        </div>

                        <!-- –£–≥–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã (–∫–∞–∫ –≤ security cameras) -->
                        <div class="corner-markers">
                            <div class="corner top-left"></div>
                            <div class="corner top-right"></div>
                            <div class="corner bottom-left"></div>
                            <div class="corner bottom-right"></div>
                        </div>
                    </div>
                </div>

                            <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
                            <div class="camera-footer">
                                <div class="footer-item">
                                    <span class="footer-icon">üì°</span>
                                    <span class="footer-text" id="signal-{{ room }}">SIGNAL OK</span>
                                </div>
                                <div class="footer-item">
                                    <span class="footer-icon" id="rec-icon-{{ room }}">‚è∫Ô∏è</span>
                                    <span class="footer-text" id="rec-status-{{ room }}">STANDBY</span>
                                </div>
                            </div>
                            
                            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                            <div class="camera-controls">
                                <button type="button" class="control-btn" onclick="takeScreenshot('{{ room }}')" title="–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç">
                                    <span class="btn-icon">üì∑</span>
                                    <span class="btn-text">SCREENSHOT</span>
                                </button>
                                <button type="button" class="control-btn" id="rec-btn-{{ room }}" onclick="toggleRecording('{{ room }}')" title="–ù–∞—á–∞—Ç—å/–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å">
                                    <span class="btn-icon">‚è∫Ô∏è</span>
                                    <span class="btn-text" id="rec-btn-text-{{ room }}">START REC</span>
                                </button>
                            </div>
            </div>
        </div>
        {% endfor %}

        {% if not rooms %}
        <div class="camera-feed">
            <div class="camera-frame">
                <div class="camera-header">
                    <div class="camera-info">
                        <span class="camera-label">NO FEED</span>
                        <span class="camera-id">CAM-00</span>
                    </div>
                </div>
                <div class="camera-view">
                    <div class="no-signal">
                        <div class="no-signal-text">NO SIGNAL</div>
                        <div class="no-signal-subtext">CAMERA OFFLINE</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('ru-RU', {hour12: false});
    const dateStr = now.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    }).replace(/\//g, '.');

    document.getElementById('monitor-time').textContent = timeStr;
    document.getElementById('monitor-date').textContent = dateStr;

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞–º–µ—Ä–µ
    document.querySelectorAll('.timestamp').forEach(el => {
        el.textContent = timeStr;
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–º–µ—Ä
function updateCameraData() {
    fetch('/api/rooms')
        .then(response => response.json())
        .then(data => {
            let totalSubjects = 0;
            Object.keys(data).forEach(roomName => {
                const roomData = data[roomName];
                const count = roomData.count || 0;
                totalSubjects += count;

                const countEl = document.getElementById(`count-${roomName}`);
                if (countEl) {
                    countEl.textContent = count;
                }
            });

            document.getElementById('total-subjects').textContent = totalSubjects;
        })
        .catch(error => console.error('Error:', error));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–º–µ—Ä
function updateCameraStatus() {
    fetch('/api/camera_status')
        .then(response => response.json())
        .then(data => {
            Object.values(data).forEach(status => {
                const statusEl = document.getElementById(`status-${status.room_name}`);
                const fpsEl = document.getElementById(`fps-${status.room_name}`);
                const resEl = document.getElementById(`res-${status.room_name}`);
                const signalEl = document.getElementById(`signal-${status.room_name}`);

                if (statusEl) {
                    const dot = statusEl.querySelector('.status-dot');
                    const text = statusEl.querySelector('.status-text');
                    if (status.status === 'active') {
                        dot.classList.add('online');
                        dot.classList.remove('offline');
                        text.textContent = 'ONLINE';
                    } else {
                        dot.classList.add('offline');
                        dot.classList.remove('online');
                        text.textContent = 'OFFLINE';
                    }
                }

                if (fpsEl) {
                    fpsEl.textContent = status.fps ? status.fps.toFixed(1) : '--';
                }

                if (resEl) {
                    resEl.textContent = `${status.frame_width || '--'}x${status.frame_height || '--'}`;
                }

                if (signalEl) {
                    signalEl.textContent = status.status === 'active' ? 'SIGNAL OK' : 'NO SIGNAL';
                    signalEl.className = 'footer-text ' + (status.status === 'active' ? 'signal-ok' : 'signal-error');
                }
            });
        })
        .catch(error => console.error('Error:', error));
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∏–¥–µ–æ
function handleVideoError(roomName) {
    const videoEl = document.getElementById(`video-${roomName}`);
    if (videoEl) {
        videoEl.style.display = 'none';
        const cameraView = videoEl.closest('.camera-view');
        if (cameraView) {
            const noSignal = document.createElement('div');
            noSignal.className = 'no-signal';
            noSignal.innerHTML = '<div class="no-signal-text">NO SIGNAL</div><div class="no-signal-subtext">CAMERA OFFLINE</div>';
            cameraView.querySelector('.video-container').appendChild(noSignal);
        }
    }
}

            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–µ—Ä—ã
            const recordingStates = {};
            
            // –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
            function takeScreenshot(roomName) {
                fetch(`/api/screenshot/${roomName}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            const btn = document.querySelector(`button[onclick*="takeScreenshot('${roomName}')"]`);
                            if (btn) {
                                const originalText = btn.querySelector('.btn-text').textContent;
                                btn.querySelector('.btn-text').textContent = 'SAVED!';
                                btn.style.background = 'rgba(0, 255, 0, 0.3)';
                                setTimeout(() => {
                                    btn.querySelector('.btn-text').textContent = originalText;
                                    btn.style.background = '';
                                }, 2000);
                            }
                            console.log('–°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data.url);
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç'));
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:', error);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞');
                    });
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∑–∞–ø–∏—Å—å
            function toggleRecording(roomName) {
                const isRecording = recordingStates[roomName] || false;
                
                if (isRecording) {
                    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                    fetch(`/api/recording/${roomName}/stop`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                recordingStates[roomName] = false;
                                updateRecordingUI(roomName, false);
                                console.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', data.filename);
                            } else {
                                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å'));
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏:', error);
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏');
                        });
                } else {
                    // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                    fetch(`/api/recording/${roomName}/start`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                recordingStates[roomName] = true;
                                updateRecordingUI(roomName, true);
                                console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞:', data.filename);
                            } else {
                                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å'));
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏:', error);
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏');
                        });
                }
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å UI –∑–∞–ø–∏—Å–∏
            function updateRecordingUI(roomName, isRecording) {
                const recBtn = document.getElementById(`rec-btn-${roomName}`);
                const recBtnText = document.getElementById(`rec-btn-text-${roomName}`);
                const recStatus = document.getElementById(`rec-status-${roomName}`);
                const recIcon = document.getElementById(`rec-icon-${roomName}`);
                
                if (isRecording) {
                    if (recBtn) {
                        recBtn.style.background = 'rgba(255, 0, 0, 0.3)';
                        recBtn.style.borderColor = '#ff0000';
                    }
                    if (recBtnText) recBtnText.textContent = 'STOP REC';
                    if (recStatus) {
                        recStatus.textContent = 'RECORDING';
                        recStatus.style.color = '#ff0000';
                    }
                    if (recIcon) {
                        recIcon.textContent = 'üî¥';
                        recIcon.style.animation = 'blink 1s infinite';
                    }
                } else {
                    if (recBtn) {
                        recBtn.style.background = '';
                        recBtn.style.borderColor = '';
                    }
                    if (recBtnText) recBtnText.textContent = 'START REC';
                    if (recStatus) {
                        recStatus.textContent = 'STANDBY';
                        recStatus.style.color = '#00aa00';
                    }
                    if (recIcon) {
                        recIcon.textContent = '‚è∫Ô∏è';
                        recIcon.style.animation = '';
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏
            function checkRecordingStatus(roomName) {
                fetch(`/api/recording/${roomName}/status`)
                    .then(response => response.json())
                    .then(data => {
                        recordingStates[roomName] = data.is_recording;
                        updateRecordingUI(roomName, data.is_recording);
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏:', error));
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            updateTime();
            updateCameraData();
            updateCameraStatus();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö –∫–∞–º–µ—Ä
            {% for room in rooms %}
            checkRecordingStatus('{{ room }}');
            {% endfor %}
            
            setInterval(updateTime, 1000);
            setInterval(updateCameraData, 2000);
            setInterval(updateCameraStatus, 3000);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏
            setInterval(function() {
                {% for room in rooms %}
                checkRecordingStatus('{{ room }}');
                {% endfor %}
            }, 2000);
            </script>
{% endblock %}